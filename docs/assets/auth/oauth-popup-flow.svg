<svg xmlns="http://www.w3.org/2000/svg" width="1214" height="1145" preserveAspectRatio="none" style="width:1214px;height:1145px;background:#fefefe" viewBox="0 0 1214 1145"><text x="461.5" y="27.402" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="287">OAuth Consent and Refresh Flow</text><path d="M120 86.688v1001.353M419.5 86.688v1001.353M839 86.688v1001.353M985 86.688v1001.353M1107 86.688v1001.353" style="stroke:#383838;stroke-width:1;stroke-dasharray:5,5"/><path fill="#F8F8F8" d="M86 55.199h69v30.488H86z" style="stroke:#383838;stroke-width:1.5"/><text x="93" y="75.734" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55">Browser</text><path fill="#F8F8F8" d="M86 1087.041h69v30.488H86z" style="stroke:#383838;stroke-width:1.5"/><text x="93" y="1107.576" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55">Browser</text><path fill="#F8F8F8" d="M361.5 55.199h116v30.488h-116z" style="stroke:#383838;stroke-width:1.5"/><text x="368.5" y="75.734" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102">Popup Window</text><path fill="#F8F8F8" d="M361.5 1087.041h116v30.488h-116z" style="stroke:#383838;stroke-width:1.5"/><text x="368.5" y="1107.576" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102">Popup Window</text><path fill="#F8F8F8" d="M760 55.199h159v30.488H760z" style="stroke:#383838;stroke-width:1.5"/><text x="767" y="75.734" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="145">auth-backend plugin</text><path fill="#F8F8F8" d="M760 1087.041h159v30.488H760z" style="stroke:#383838;stroke-width:1.5"/><text x="767" y="1107.576" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="145">auth-backend plugin</text><text x="929" y="83.734" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="107">Consent Screen</text><circle cx="985.5" cy="54.199" r="12" fill="#F8F8F8" style="stroke:#383838;stroke-width:2"/><path fill="#383838" d="m981.5 42.2 6-5-2 5 2 5-6-5z" style="stroke:#383838;stroke-width:1"/><text x="929" y="1100.576" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="107">Consent Screen</text><circle cx="985.5" cy="1119.529" r="12" fill="#F8F8F8" style="stroke:#383838;stroke-width:2"/><path fill="#383838" d="m981.5 1107.53 6-5-2 5 2 5-6-5z" style="stroke:#383838;stroke-width:1"/><text x="1052" y="83.734" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105">OAuth Provider</text><circle cx="1107.5" cy="54.199" r="12" fill="#F8F8F8" style="stroke:#383838;stroke-width:2"/><path d="M1095.5 68.199h24" style="stroke:#383838;stroke-width:2"/><text x="1052" y="1100.576" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105">OAuth Provider</text><circle cx="1107.5" cy="1119.529" r="12" fill="#F8F8F8" style="stroke:#383838;stroke-width:2"/><path d="M1095.5 1133.529h24" style="stroke:#383838;stroke-width:2"/><path fill="#ECECEC" d="M8 101.688v55h225v-45l-10-10H8" style="stroke:#383838;stroke-width:1"/><path fill="#ECECEC" d="M223 101.688v10h10l-10-10" style="stroke:#383838;stroke-width:1"/><text x="14" y="119.256" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201">Components on page ask for an</text><text x="14" y="134.566" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161">access token with greater</text><text x="14" y="149.877" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204">scope than the existing session.</text><path fill="#383838" d="m407.5 179.93 10 4-10 4 4-4z" style="stroke:#383838;stroke-width:1"/><path d="M120.5 183.93h293" style="stroke:#383838;stroke-width:1"/><text x="127.5" y="179.188" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77">Open popup</text><path fill="#383838" d="m827.5 209.24 10 4-10 4 4-4z" style="stroke:#383838;stroke-width:1"/><path d="M419.5 213.24h414" style="stroke:#383838;stroke-width:1"/><text x="426.5" y="208.498" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333">GET /auth/&lt;provider&gt;/start?scope=some%20scopes</text><path fill="#383838" d="m430.5 269.172-10 4 10 4-4-4z" style="stroke:#383838;stroke-width:1"/><path d="M424.5 273.172h414" style="stroke:#383838;stroke-width:1"/><text x="436.5" y="237.809" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198">Redirect to consent screen with</text><text x="436.5" y="253.119" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212">random nonce in OAuth state and</text><text x="436.5" y="268.43" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255">short-lived cookie with the same nonce.</text><path fill="#383838" d="m973.5 313.793 10 4-10 4 4-4z" style="stroke:#383838;stroke-width:1"/><path d="M419.5 317.793h560" style="stroke:#383838;stroke-width:1"/><text x="426.5" y="297.74" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="369">GET /consent_url?redirect_uri=&lt;redirect_uri&gt;?nonce=&lt;n&gt;</text><text x="426.5" y="313.051" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="422">where redirect_uri=&lt;app-origin&gt;/auth/&lt;provider&gt;/handler/frame</text><path fill="#ECECEC" d="M905 330.793v40h161v-30l-10-10H905" style="stroke:#383838;stroke-width:1"/><path fill="#ECECEC" d="M1056 330.793v10h10l-10-10" style="stroke:#383838;stroke-width:1"/><text x="911" y="348.361" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106">User consents to</text><text x="911" y="363.672" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140">access the new scope.</text><path fill="#383838" d="m430.5 393.725-10 4 10 4-4-4z" style="stroke:#383838;stroke-width:1"/><path d="M424.5 397.725h560" style="stroke:#383838;stroke-width:1"/><text x="436.5" y="392.982" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343">Redirect to given redirect URL, with authorization code</text><path fill="#383838" d="m827.5 438.346 10 4-10 4 4-4z" style="stroke:#383838;stroke-width:1"/><path d="M419.5 442.346h414" style="stroke:#383838;stroke-width:1"/><text x="426.5" y="422.293" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396">GET /auth/&lt;provider&gt;/handler/frame?code=&lt;c&gt;&amp;nonce=&lt;n&gt;</text><text x="426.5" y="437.603" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304">Request includes the previously set none cookie</text><path fill="#ECECEC" d="M710 455.346v40h259v-30l-10-10H710" style="stroke:#383838;stroke-width:1"/><path fill="#ECECEC" d="M959 455.346v10h10l-10-10" style="stroke:#383838;stroke-width:1"/><text x="716" y="472.914" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217">Verify that the nonce in the cookie</text><text x="716" y="488.225" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238">matches the nonce in the OAuth state</text><path fill="#383838" d="m1095.5 548.898 10 4-10 4 4-4z" style="stroke:#383838;stroke-width:1"/><path d="M839.5 552.898h262" style="stroke:#383838;stroke-width:1"/><text x="846.5" y="517.535" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122">Authorization Code</text><text x="846.5" y="532.846" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55">Client ID</text><text x="846.5" y="548.156" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79">Client Secret</text><path fill="#ECECEC" d="M1013 565.898v25h189v-15l-10-10h-179" style="stroke:#383838;stroke-width:1"/><path fill="#ECECEC" d="M1192 565.898v10h10l-10-10" style="stroke:#383838;stroke-width:1"/><text x="1019" y="583.467" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168">Verify and generate tokens</text><path fill="#383838" d="m850.5 674.762-10 4 10 4-4-4z" style="stroke:#383838;stroke-width:1"/><path d="M844.5 678.762h262" style="stroke:#383838;stroke-width:1"/><text x="856.5" y="612.777" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87">Access Token</text><text x="856.5" y="628.088" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65">(ID Token)</text><text x="856.5" y="643.398" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98">(Refresh Token)</text><text x="856.5" y="658.709" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="37">Scope</text><text x="856.5" y="674.019" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74">Expire Time</text><path fill="#383838" d="m430.5 719.383-10 4 10 4-4-4z" style="stroke:#383838;stroke-width:1"/><path d="M424.5 723.383h414" style="stroke:#383838;stroke-width:1"/><text x="436.5" y="703.33" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300">Small HTML page with inlined response payload</text><text x="436.5" y="718.641" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260">Store Refresh Token in HTTP-only cookie</text><path fill="#383838" d="m131.5 748.693-10 4 10 4-4-4z" style="stroke:#383838;stroke-width:1"/><path d="M125.5 752.693h293" style="stroke:#383838;stroke-width:1"/><text x="137.5" y="747.951" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275">postMessage() with tokens and info or error</text><path d="M419.5 782.004h42m0 0v13m-41 0h41" style="stroke:#383838;stroke-width:1"/><path fill="#383838" d="m430.5 791.004-10 4 10 4-4-4z" style="stroke:#383838;stroke-width:1"/><text x="426.5" y="777.262" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62">Close self</text><path fill="#ECECEC" d="M9 808.004v55h223v-45l-10-10H9" style="stroke:#383838;stroke-width:1"/><path fill="#ECECEC" d="M222 808.004v10h10l-10-10" style="stroke:#383838;stroke-width:1"/><text x="15" y="825.572" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174">A later point when a refresh</text><text x="19" y="840.883" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176">is needed. Either because of</text><text x="19" y="856.193" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198">a reload or an expiring session.</text><path fill="#383838" d="m827.5 901.557 10 4-10 4 4-4z" style="stroke:#383838;stroke-width:1"/><path d="M120.5 905.557h713" style="stroke:#383838;stroke-width:1"/><text x="127.5" y="885.504" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185">GET /auth/&lt;provider&gt;/token</text><text x="127.5" y="900.814" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194">Refresh Token cookie included</text><path fill="#383838" d="m1095.5 961.488 10 4-10 4 4-4z" style="stroke:#383838;stroke-width:1"/><path d="M839.5 965.488h262" style="stroke:#383838;stroke-width:1"/><text x="846.5" y="930.125" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90">Refresh Token</text><text x="846.5" y="945.436" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55">Client ID</text><text x="846.5" y="960.746" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79">Client Secret</text><path fill="#383838" d="m850.5 1036.73-10 4 10 4-4-4z" style="stroke:#383838;stroke-width:1"/><path d="M844.5 1040.73h262" style="stroke:#383838;stroke-width:1"/><text x="856.5" y="990.057" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87">Access Token</text><text x="856.5" y="1005.367" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65">(ID Token)</text><text x="856.5" y="1020.678" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="37">Scope</text><text x="856.5" y="1035.988" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74">Expire Time</text><path fill="#383838" d="m131.5 1066.041-10 4 10 4-4-4z" style="stroke:#383838;stroke-width:1"/><path d="M125.5 1070.041h713" style="stroke:#383838;stroke-width:1"/><text x="137.5" y="1065.299" font-family="Segoe UI, Helvetica, Arial, sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102">Tokens and info</text></svg>